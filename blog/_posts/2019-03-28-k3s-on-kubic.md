---
layout: post
title:  "Getting started with k3s on Kubic"
date:   2019-03-28 10:00:00 +0200
author: Guillaume Gardet
---

[k3s](https://k3s.io/), the lightweight Kubernetes, is now available on Kubic!


## What is k3s?


k3s is a lightweight version of k8s, developped by Rancher Labs, with the following changes. 
It removes:

 * Legacy and non-default features
 * Alpha features
 * In-tree cloud providers
 * In-tree storage drivers
 * Docker (optional)

It adds:

 * Simplified installation
 * SQLite3 support in addition to etcd
 * TLS management
 * Automatic Manifest and Helm Chart management
 * containerd, CoreDNS, Flannel

As a result, you may miss some features of k8s. But k3s uses less disk space and less RAM than k8s, so it is intended to be used on small systems such as [Raspberry Pi 3](https://en.opensuse.org/HCL:Raspberry_Pi3), where a full k8s system will eat all the memory. But it can also be used on higher end machines.

If you know k8s already, it will be easy to move to k3s as, once installed, most commands are the same.


## How to use k3s?

### Machines configuration: server and node(s)

#### k3s server

You must start to setup a k3s server as a starting point. 
Please install a MicroOS Kubic and install `k3s` on top:

```bash
transactional-update pkg install k3s
reboot
```
_Note: if you use a kubeadm Kubic, installing `k3s` will require to uninstall kubernetes packages, as they conflicts. This will be handled by `transactional-update`._

If you use a ready to use image, such as on the [Raspberry Pi 3](https://en.opensuse.org/HCL:Raspberry_Pi3), you need to define a hostname (not localhost) with a [cloud-init config](https://en.opensuse.org/Kubic:MicroOS/cloud-init), or manually with `hostnamectl set-hostname k3smaster`.

If your DNS does not bind your hostname to your IP, you need to do it in `/etc/hosts`

Optionnaly, you can set some configuration options in `/etc/rancher/k3s/server.conf`. 
You may want to disable k3s agent on your k3s server by adding `--disable-agent`, to avoid to run any pod on server.

Now, enable k3s server start on boot and start it now:

```bash
systemctl enable k3s-server
systemctl start k3s-server
```

Wait a while for k3s to start and to download the required images from the Kubernetes registry.
You can check the current status (if k3s server also act as a node) with `kubectl get node -o wide` which will return:

```bash
NAME          STATUS     ROLES    AGE   VERSION         INTERNAL-IP    EXTERNAL-IP   OS-IMAGE                    KERNEL-VERSION             CONTAINER-RUNTIME
k3smaster     Ready      <none>   14h   v1.13.4-k3s.1   192.168.0.44   <none>        openSUSE Tumbleweed Kubic   4.20.13-1-default          containerd://1.2.2
```


#### k3s node(s)

For your k3s nodes, you must also start with a MicroOS Kubic and install `k3s` on top:

```bash
transactional-update pkg install k3s
reboot
```
_Note: if you use a kubeadm Kubic, installing `k3s` will require to uninstall kubernetes packages, as they conflicts. This will be handled by `transactional-update`._

If you use a ready to use image, such as on the [Raspberry Pi 3](https://en.opensuse.org/HCL:Raspberry_Pi3), you need to define a hostname (not localhost) with a [cloud-init config](https://en.opensuse.org/Kubic:MicroOS/cloud-init), or manually with `hostnamectl set-hostname k3snode1`.

If your DNS does not bind your hostname to your IP, you need to do it in `/etc/hosts`

Now, set config values in `/etc/rancher/k3s/agent.conf`. It includes the server URL and the NODE_TOKEN which is defined in `/var/lib/rancher/k3s/server/node-token` on the k3s server.


Now, enable k3s agent start on boot and start it now:

```bash
systemctl enable k3s-agent
systemctl start k3s-agent
```

From the `k3smaster` machine, you can check the current node status with `kubectl get node -o wide` which will return:

```bash
NAME          STATUS     ROLES    AGE   VERSION         INTERNAL-IP    EXTERNAL-IP   OS-IMAGE                    KERNEL-VERSION             CONTAINER-RUNTIME
k3smaster     Ready      <none>   14h   v1.13.4-k3s.1   192.168.0.44   <none>        openSUSE Tumbleweed Kubic   4.20.13-1-default          containerd://1.2.2
k3snode1      Ready      <none>   14h   v1.13.4-k3s.1   192.168.0.50   <none>        openSUSE Tumbleweed Kubic   4.20.13-1-default          containerd://1.2.2
```

**Congratulations!** You now have a working k3s cluster.


### Deploy your apps

Now that you have a k3s master and k3s nodes, you can deploy your apps as you would do with k8s.


#### Example with openfaas

Download required yaml files from github:

```bash
git clone https://github.com/openfaas/faas-netes && cd faas-netes
```

Apply downloaded YAML:

 * For x86_64:

```bash
kubectl apply -f namespaces.yml,./yaml
```

 * For aarch64:

```bash
kubectl apply -f namespaces.yml,./yaml_arm64
```


You can check openfaas pods are running with:

```bash
kubectl get --all-namespaces pod
```
Once pods are running, try it with a web browser: [http://k3smaster:31112](http://k3smaster:31112) (use IP address of the k8s master instead of `k3smaster`, if `k3smaster` hostname is not resolved by your DNS)

